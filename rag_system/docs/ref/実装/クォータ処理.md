# API Quota 制限対策 (Gemini Embedding - `google.api_core.exceptions.ResourceExhausted` を明示的にキャッチ
- 他のエラーは即座に失敗させる(無駄なリトライを避ける)

### B. Document AI Batch Processing

#### 1. **指数バックオフリトライ**
```python
max_retries = 3
base_delay = 5.0  # 5秒
delays: 5s, 10s, 20s
```
- 429エラー発生時、自動的に最大3回リトライ
- バッチ処理は完了まで時間がかかるため、長めの待機時間

#### 2. **同時実行数制限の管理**
- **無料枠**: 5個の同時バッチ処理
- **推奨**: Cloud Runの同時実行数を制限して、同時バッチ数を抑える
- **代替案**: 大量ファイルは時間差で処理 (Cloud Scheduler)

#### 3. **ページ数による処理分岐**
```python
1-15ページ: 同期処理 (ProcessDocument)
16-30ページ: バッチ処理 (BatchProcessDocuments)
31ページ以上: スキップ (制限超過)
```

## ベストプラクティスcument AI)

## 問題

### 1. Gemini Embedding API
(`gemini-embedding-001`) のクォータ制限:
- **無料枠**: 60 requests/分
- **エラー**: `429 RESOURCE_EXHAUSTED: Quota exceeded for gemini-embedding`

### 2. Document AI Batch Processing
バッチ処理の同時実行数制限:
- **無料枠**: 5個の同時バッチ処理リクエスト (US region)
- **エラー**: `429 Quota limit 'ProcessorConcurrentBatchProcessDocumentRequestsPerProjectUS' exceeded`

## 実装した対策

### A. Gemini Embedding API

#### 1. **レート制限 (Rate Limiting)**
```python
MIN_REQUEST_INTERVAL = 1.0  # 1秒間隔 (60 RPM)
```
- リクエスト間に最低1秒の待機時間を設定
- 連続リクエストによるクォータ超過を防止

#### 2. **指数バックオフ (Exponential Backoff)**
```python
max_retries = 5
base_delay = 1.0
delay = base_delay * (2 ** attempt)  # 1s, 2s, 4s, 8s, 16s
```
- 429エラー発生時、自動的にリトライ
- 待機時間を指数的に増加させて負荷を分散

#### 3. **エラーハンドリング**
- `google.api_core.exceptions.ResourceExhausted` を明示的にキャッチ
- 他のエラーは即座に失敗させる（無駄なリトライを避ける）

## ベストプラクティス

### Google Cloud公式推奨事項
1. **バッチ処理**: 可能な限りリクエストをまとめる
2. **キャッシング**: 同じテキストのembeddingを再利用
3. **クォータ引き上げリクエスト**: 本番環境では必須
   - https://cloud.google.com/vertex-ai/docs/generative-ai/quotas-genai

### 現在の実装 (Gemini Embedding)
- ✅ レート制限 (1秒/リクエスト)
- ✅ 指数バックオフリトライ (5回まで)
- ✅ ResourceExhausted 専用ハンドリング
- ⚠️ バッチ処理は未実装 (将来的に検討)

### 現在の実装 (Document AI)
- ✅ 指数バックオフリトライ (3回まで、5s/10s/20s)
- ✅ ResourceExhausted 専用ハンドリング
- ✅ ページ数による処理分岐 (1-15: sync, 16-30: batch)
- ⚠️ 同時実行数の動的制御は未実装

## クォータ引き上げ方法

### Gemini Embedding API

#### 1. Google Cloud Console
```
https://console.cloud.google.com/apis/api/aiplatform.googleapis.com/quotas?project=fractalautomations
```

#### 2. gcloud コマンド
```bash
gcloud alpha services quota update \
  --service=aiplatform.googleapis.com \
  --quota-id=online_prediction_requests_per_base_model \
  --value=1000 \
  --project=fractalautomations
```

#### 3. 申請フォーム
```
https://cloud.google.com/vertex-ai/docs/generative-ai/quotas-genai
```

### Document AI Batch Processing

#### 1. Google Cloud Console
```
https://console.cloud.google.com/apis/api/documentai.googleapis.com/quotas?project=fractalautomations
```

#### 2. クォータ引き上げリクエスト
- **制限名**: `ProcessorConcurrentBatchProcessDocumentRequestsPerProjectUS`
- **現在の制限**: 5個の同時実行
- **推奨値**: 10-20個 (本番環境)

#### 3. gcloud コマンド
```bash
gcloud alpha services quota update \
  --service=documentai.googleapis.com \
  --quota-id=ProcessorConcurrentBatchProcessDocumentRequestsPerProjectUS \
  --value=20 \
  --project=fractalautomations
```

## 監視とアラート

### Cloud Loggingで監視
```
severity="WARNING"
jsonPayload.message=~"Quota exhausted"
```

### 推奨メトリクス
- `aiplatform.googleapis.com/quota/online_prediction_requests_per_base_model/usage`
- `aiplatform.googleapis.com/quota/online_prediction_requests_per_base_model/limit`

## トラブルシューティング

### エラーが続く場合
1. **Cloud Run のタイムアウト設定を確認**
   ```bash
   gcloud run services describe vectorize-document --region=asia-northeast1
   ```
   - デフォルト: 300秒 (5分)
   - 推奨: 600秒 (10分) 以上

2. **同時実行数を制限**
   ```bash
   gcloud run services update vectorize-document \
     --max-instances=1 \
     --region=asia-northeast1
   ```
   - 複数インスタンスが同時にAPIを呼ぶとクォータを消費しやすい

3. **処理を分散**
   - Cloud Scheduler で時間帯を分散
   - 大量ファイルは夜間バッチ処理

## 参考資料
- [Vertex AI Quotas](https://cloud.google.com/vertex-ai/docs/quotas)
- [Gemini API Best Practices](https://cloud.google.com/vertex-ai/generative-ai/docs/learn/best-practices)
- [Exponential Backoff](https://cloud.google.com/iot/docs/how-tos/exponential-backoff)
