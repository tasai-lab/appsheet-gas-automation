# デプロイガイド

## 概要

Google Apps Script（GAS）プロジェクトのデプロイとバージョン管理の手順を説明します。

## デプロイの種類

### 1. テストデプロイ

開発中のスクリプトをテスト実行する際に使用：

```bash
# GASエディタで「デプロイ」→「デプロイをテスト」
```

- URLが毎回変わる
- 本番環境に影響しない
- 開発時のテストに最適

### 2. 本番デプロイ

実際に使用するWebアプリやAPIとしてデプロイ：

```bash
# GASエディタで「デプロイ」→「新しいデプロイ」
```

- 固定URLが発行される
- バージョン管理される
- Webhookなどに使用

## デプロイ手順

### 手動デプロイ（GASエディタ）

1. **GASエディタを開く**
   - Google Driveでスクリプトファイルを開く
   - 「拡張機能」→「Apps Script」

2. **デプロイ設定**
   - 右上の「デプロイ」ボタンをクリック
   - 「新しいデプロイ」を選択

3. **デプロイタイプを選択**
   - 「ウェブアプリ」を選択
   - 説明を入力（例: "v1.2.3 - 重複防止機能追加"）

4. **アクセス権限の設定**
   - 実行ユーザー: 自分
   - アクセスできるユーザー: 全員（Webhookの場合）

5. **デプロイ実行**
   - 「デプロイ」ボタンをクリック
   - URLをコピーして保存

### 自動デプロイ（Pythonスクリプト）

#### 全スクリプトのデプロイ

```bash
python deploy_all_to_gas.py
```

このスクリプトは以下を実行：
1. `gas_projects/`内の全プロジェクトを検索
2. 各プロジェクトのスクリプトをGASにアップロード
3. 既存のプロジェクトIDを使用して更新

#### 変更があったスクリプトのみデプロイ

```bash
python batch_update_deployments.py
```

Git管理されている場合、変更を検出して必要なスクリプトのみデプロイします。

## バージョン管理

### バージョン番号の規則

セマンティックバージョニングを使用：

```
v[Major].[Minor].[Patch]

例:
v1.0.0 - 初回リリース
v1.1.0 - 新機能追加
v1.1.1 - バグ修正
v2.0.0 - 破壊的変更
```

- **Major**: 互換性のない変更
- **Minor**: 後方互換性のある機能追加
- **Patch**: 後方互換性のあるバグ修正

### バージョンの更新

#### 手動更新

1. GASエディタで「デプロイ」→「デプロイを管理」
2. 既存のデプロイの「編集」アイコンをクリック
3. 「バージョン」→「新しいバージョン」
4. 説明を入力してデプロイ

#### 自動更新

```bash
python update_all_deployment_versions.py
```

全てのデプロイバージョンを自動的に更新します。

### デプロイ履歴の確認

```bash
# GASエディタで確認
「デプロイ」→「デプロイを管理」→「バージョン」タブ

# または、実行ログスプレッドシートで確認
```

## Webhook URL管理

### URLの取得

デプロイ後に発行されるWebhook URL：

```
https://script.google.com/macros/s/{DEPLOYMENT_ID}/exec
```

### AppSheetへの設定

1. AppSheetエディタを開く
2. 「Automation」→「Bots」
3. 該当のBotを選択
4. 「Tasks」→「Call a webhook」
5. URLを更新して保存

### URL変更時の注意

- テストデプロイのURLは毎回変わる
- 本番デプロイのURLは固定（バージョン更新しても変わらない）
- 新しいデプロイを作成すると新しいURLが発行される

## デプロイの戦略

### 開発フロー

```
1. ローカルで開発
   ↓
2. GASにアップロード（python deploy_all_to_gas.py）
   ↓
3. テストデプロイで動作確認
   ↓
4. 問題なければ本番デプロイ
   ↓
5. バージョン番号を更新
   ↓
6. 実行ログで監視
```

### ロールバック

問題が発生した場合、以前のバージョンに戻す：

1. GASエディタで「デプロイ」→「デプロイを管理」
2. 「バージョン」ドロップダウンから以前のバージョンを選択
3. 「デプロイを更新」

または:

```bash
# 特定バージョンに戻す
python update_deployment_version.py --version 前のバージョン番号
```

### ブルーグリーンデプロイ

重要なスクリプトの場合：

1. 新しいデプロイを作成（Green）
2. 一部のトラフィックで動作確認
3. 問題なければ全トラフィックを新デプロイに切り替え
4. 古いデプロイ（Blue）を削除

## 認証とスコープ

### 必要なスコープ

```json
{
  "oauthScopes": [
    "https://www.googleapis.com/auth/script.external_request",
    "https://www.googleapis.com/auth/spreadsheets",
    "https://www.googleapis.com/auth/drive",
    "https://www.googleapis.com/auth/script.scriptapp"
  ]
}
```

### スコープの追加

GASエディタで`appsscript.json`を編集：

1. 「プロジェクトの設定」をクリック
2. 「マニフェストファイルを編集に表示する」をチェック
3. `appsscript.json`にスコープを追加
4. 保存してデプロイ

### 再認証

新しいスコープを追加した場合、再認証が必要：

```bash
# Pythonスクリプトで再認証
python reauth_with_full_scopes.py

# またはGASエディタで手動実行して承認
```

## トラブルシューティング

### デプロイエラー

**エラー: "Authorization required"**

原因: 認証スコープが不足

対策:
1. `appsscript.json`でスコープを追加
2. 再認証を実行
3. 再度デプロイ

**エラー: "Script has too many triggers"**

原因: トリガー数の上制限（20個）

対策:
1. 不要なトリガーを削除
2. 複数のトリガーを1つに統合

### アップロードエラー

**エラー: "File not found"**

原因: プロジェクトIDが正しくない

対策:
1. GASのURLからプロジェクトIDを確認
2. `.clasp.json`のscriptIdを修正

**エラー: "Push failed"**

原因: ファイル構成が正しくない

対策:
1. ファイル構造を確認
2. `.gs`と`.html`ファイルのみ含まれているか確認

### バージョン管理エラー

**エラー: "Deployment not found"**

原因: デプロイIDが存在しない

対策:
1. GASエディタでデプロイ一覧を確認
2. 正しいデプロイIDを使用

## ベストプラクティス

### 1. デプロイ前のチェックリスト

- [ ] ローカルでテスト済み
- [ ] コードレビュー完了
- [ ] ドキュメント更新
- [ ] バージョン番号決定
- [ ] 変更内容を記録

### 2. デプロイ時の記録

```javascript
// デプロイログを実行ログに記録
logToSheet(
  'INFO',
  'deployment',
  'v1.2.3をデプロイしました',
  '変更内容: 重複防止機能の追加、Geminiモデルの最適化'
);
```

### 3. 段階的なロールアウト

- まずテスト環境でデプロイ
- 一部のユーザーで動作確認
- 問題なければ全体に展開

### 4. モニタリング

デプロイ後は必ず監視：

```javascript
// デプロイ後の監視関数
function monitorDeployment() {
  const errors = getRecentErrors();
  if (errors.length > 5) {
    // 異常なエラー数の場合は通知
    logToSheet('WARNING', 'monitorDeployment', 
      `デプロイ後のエラー数が多い: ${errors.length}件`);
  }
}
```

### 5. ドキュメント化

全てのデプロイを記録：

- デプロイ日時
- バージョン番号
- 変更内容
- 担当者
- テスト結果

## デプロイスケジュール

### 推奨スケジュール

- **毎週水曜日**: マイナーアップデート、バグ修正
- **毎月第2火曜日**: メジャーアップデート、新機能
- **緊急時**: クリティカルなバグ修正は即座に

### メンテナンスウィンドウ

システム停止が必要な場合：

1. 事前通知（1週間前）
2. メンテナンス時間の設定（例: 日曜日午前2-4時）
3. バックアップの作成
4. 作業実施
5. 動作確認
6. 完了通知

## まとめ

適切なデプロイとバージョン管理により、安定したシステム運用が可能になります。自動化ツールを活用しつつ、重要な変更は慎重に段階的にデプロイしましょう。

## 参考

- [deploy_all_to_gas.py](../../deploy_all_to_gas.py) - 全スクリプトデプロイ
- [batch_update_deployments.py](../../batch_update_deployments.py) - 差分デプロイ
- [update_all_deployment_versions.py](../../update_all_deployment_versions.py) - バージョン更新
